<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-2396877498000532",
    enable_page_level_ads: true
  });
</script>
    
    <title>Hexo Source Code Demystified | Searene</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="" />
    
    <meta name="description" content="PrefaceHexo is an excellent static blog generator, I read its source code recently, and I think it’s worth sharing the inner mechanism of its source code. GeneratorWhen you run the command hexo genera">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo Source Code Demystified">
<meta property="og:url" content="http://searene.me/2016/07/17/Hexo-Source-Code-Demystified/index.html">
<meta property="og:site_name" content="Searene">
<meta property="og:description" content="PrefaceHexo is an excellent static blog generator, I read its source code recently, and I think it’s worth sharing the inner mechanism of its source code. GeneratorWhen you run the command hexo genera">
<meta property="og:image" content="http://i.imgur.com/fB0X6I3.png">
<meta property="og:updated_time" content="2016-12-06T14:08:49.749Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo Source Code Demystified">
<meta name="twitter:description" content="PrefaceHexo is an excellent static blog generator, I read its source code recently, and I think it’s worth sharing the inner mechanism of its source code. GeneratorWhen you run the command hexo genera">
<meta name="twitter:image" content="http://i.imgur.com/fB0X6I3.png">
    

    

    

    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/vendor/titillium-web/styles.css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/vendor/jquery/2.0.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/vendor/fancybox/jquery.fancybox.css">
    
    
        <link rel="stylesheet" href="/vendor/scrollLoading/style.css">
    
    
        <script type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-71019366-1', 'auto');
ga('send', 'pageview');

</script>
    
    

</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">Home</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Coding/">Coding</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Journal/">Journal</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Journey/">Journey</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Math/">Math</a></li></ul>
                                    
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">About</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Coding/">Coding</a>
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-Hexo-Source-Code-Demystified" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        Hexo Source Code Demystified
        </h1>
    

            </header>
        
        <div class="article-subtitle">
            <a href="/2016/07/17/Hexo-Source-Code-Demystified/" class="article-date">
    <time datetime="2016-07-16T23:52:23.000Z" itemprop="datePublished">2016-07-17</time>
</a>
            
        </div>
        <div class="article-entry" itemprop="articleBody">
            <h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p>Hexo is an excellent static blog generator, I read its source code recently, and I think it’s worth sharing the inner mechanism of its source code.</p>
<h1 id="Generator"><a href="#Generator" class="headerlink" title="Generator"></a>Generator</h1><p>When you run the command <code>hexo generate</code>, hexo will generate all the static files for you. This is the part we are going to start with. The directory where <code>hexo generate</code> is executed is <code>/home/searene/Development/hexo-twenty-sixteen</code> in this tutorial.</p>
<p>First, we can find the location of the tool <code>hexo</code> with the command <code>which</code>.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">which hexo</div></pre></td></tr></table></figure>
<p>My output is</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/home/searene/.nvm/versions/node/v5.0.0/bin/hexo</div></pre></td></tr></table></figure>
<p>This is a soft link, we get the location of the original file with <code>ll</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ll ~/.nvm/versions/node/v5.0.0/bin/hexo </div><div class="line"></div><div class="line">lrwxrwxrwx 1 searene searene 37 May 24 01:15 /home/searene/.nvm/versions/node/v5.0.0/bin/hexo -&gt; ../lib/node_modules/hexo-cli/bin/hexo</div></pre></td></tr></table></figure>
<p>The contents of <code>hexo</code> are as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env node</span></div><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"><span class="built_in">require</span>(<span class="string">'../lib/hexo'</span>)();</div></pre></td></tr></table></figure>
<p>It requires a js file called <code>hexo</code>, which is located in <code>/home/searene/.nvm/versions/node/v5.0.0/lib/node_modules/hexo-cli/lib/hexo.js</code> in my case. The beginning part of the file is as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>);</div><div class="line"><span class="keyword">var</span> tildify = <span class="built_in">require</span>(<span class="string">'tildify'</span>);</div><div class="line"><span class="keyword">var</span> pathFn = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">'bluebird'</span>);</div><div class="line"><span class="keyword">var</span> Context = <span class="built_in">require</span>(<span class="string">'./context'</span>);</div><div class="line"><span class="keyword">var</span> findPkg = <span class="built_in">require</span>(<span class="string">'./find_pkg'</span>);</div><div class="line"><span class="keyword">var</span> goodbye = <span class="built_in">require</span>(<span class="string">'./goodbye'</span>);</div><div class="line"><span class="keyword">var</span> minimist = <span class="built_in">require</span>(<span class="string">'minimist'</span>);</div><div class="line"><span class="keyword">var</span> camelCaseKeys = <span class="built_in">require</span>(<span class="string">'hexo-util/lib/camel_case_keys'</span>);</div></pre></td></tr></table></figure>
<p>It requires several packages.</p>
<ol>
<li><code>chalk</code> is used for colorful outputs,.</li>
<li><code>tildify</code> is used to convert an absolute path to a tilde path:, like <code>/Users/sindresorhus/dev</code> → <code>~/dev</code>.</li>
<li><code>context</code> is used to //TODO</li>
<li><code>find_pkg</code> is used to find the local hexo directory that contains <code>node_modules</code></li>
<li><code>goodbye</code> is used to generate a random goodbye sentence.</li>
<li><code>minimist</code> is used to parse argument options.</li>
<li><code>camelCaseKeys</code> is used to convert keys in parameters to the camelCased ones</li>
</ol>
<p>Let’s continue to read the file.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">entry</span>(<span class="params">cwd, args</span>) </span>&#123;</div><div class="line">  <span class="comment">// cwd is the directory where you invoked the node command</span></div><div class="line">  cwd = cwd || process.cwd();</div><div class="line">  <span class="comment">// the keys in args is camelCased</span></div><div class="line">  args = camelCaseKeys(args || minimist(process.argv.slice(<span class="number">2</span>)));</div><div class="line"></div><div class="line">  <span class="keyword">var</span> hexo = <span class="keyword">new</span> Context(cwd, args);</div><div class="line">  <span class="keyword">var</span> log = hexo.log;</div><div class="line"></div><div class="line">  <span class="comment">// Change the title in console</span></div><div class="line">  process.title = <span class="string">'hexo'</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">    log.fatal(err);</div><div class="line">    process.exit(<span class="number">2</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/* findPkg searched upwards from the working directory(cwd) to</span></div><div class="line">     find a directory containing package.json where the key hexo lies,</div><div class="line">     a promise is returned by the function. */</div><div class="line">  <span class="keyword">return</span> findPkg(cwd, args).then(<span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!path) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* hexo.base_dir is set as the found directory, which is </span></div><div class="line">       /home/searene/Development/hexo-twenty-sixteen */</div><div class="line">    hexo.base_dir = path;</div><div class="line"></div><div class="line">    <span class="comment">/* loadModule loads the hexo package located in the working</span></div><div class="line">       directory(/home/searene/Development/hexo-twenty-sixteen)</div><div class="line">       and returns a promise, the resolve function will carry a</div><div class="line">       newly-constructed Hexo(return new Hexo(path, args)) object </div><div class="line">       afterwards. From now on, local hexo will be used instead </div><div class="line">       of the global one. */</div><div class="line">    <span class="keyword">return</span> loadModule(path, args).catch(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      log.error(<span class="string">'Local hexo not found in %s'</span>, chalk.magenta(tildify(path)));</div><div class="line">      log.error(<span class="string">'Try running: \'npm install hexo --save\''</span>);</div><div class="line">      process.exit(<span class="number">2</span>);</div><div class="line">    &#125;);</div><div class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">mod</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mod) hexo = mod;</div><div class="line">    log = hexo.log;</div><div class="line"></div><div class="line">    <span class="built_in">require</span>(<span class="string">'./console'</span>)(hexo);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> hexo.init();</div><div class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> cmd = <span class="string">''</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!args.h &amp;&amp; !args.help) &#123;</div><div class="line">      cmd = args._.shift();</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (cmd) &#123;</div><div class="line">        <span class="keyword">var</span> c = hexo.extend.console.get(cmd);</div><div class="line">        <span class="keyword">if</span> (!c) cmd = <span class="string">'help'</span>;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        cmd = <span class="string">'help'</span>;</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      cmd = <span class="string">'help'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    watchSignal(hexo);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> hexo.call(cmd, args).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">return</span> hexo.exit();</div><div class="line">    &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">      <span class="keyword">return</span> hexo.exit(err).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        handleError(err);</div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;).catch(handleError);</div><div class="line">&#125;</div><div class="line"></div><div class="line">entry.console = &#123;</div><div class="line">  <span class="attr">init</span>: <span class="built_in">require</span>(<span class="string">'./console/init'</span>),</div><div class="line">  <span class="attr">help</span>: <span class="built_in">require</span>(<span class="string">'./console/help'</span>),</div><div class="line">  <span class="attr">version</span>: <span class="built_in">require</span>(<span class="string">'./console/version'</span>)</div><div class="line">&#125;;</div><div class="line"></div><div class="line">entry.version = <span class="built_in">require</span>(<span class="string">'../package.json'</span>).version;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadModule</span>(<span class="params">path, args</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.try(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> modulePath = pathFn.join(path, <span class="string">'node_modules'</span>, <span class="string">'hexo'</span>);</div><div class="line">    <span class="keyword">var</span> Hexo = <span class="built_in">require</span>(modulePath);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Hexo(path, args);</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">watchSignal</span>(<span class="params">hexo</span>) </span>&#123;</div><div class="line">  process.on(<span class="string">'SIGINT'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    hexo.log.info(goodbye());</div><div class="line">    hexo.unwatch();</div><div class="line"></div><div class="line">    hexo.exit().then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      process.exit();</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = entry;</div></pre></td></tr></table></figure>
<p>Notice the last part</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = entry;</div></pre></td></tr></table></figure>
<p>Remember the contents of <code>hexo.js</code>?</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">require</span>(<span class="string">'../lib/hexo'</span>)();</div></pre></td></tr></table></figure>
<p>So what <code>hexo.js</code> does is calling the <code>entry</code> function. Here comes the question, what does <code>entry</code> do?</p>
<ol>
<li><p>It searched upwards from the working directory looking for <code>package.json</code> containing the key <code>hexo</code>.</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">findPkg</span>(<span class="params">cwd, args</span>) </span>&#123;</div><div class="line">  args = args || &#123;&#125;;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (args.cwd) &#123;</div><div class="line">    cwd = pathFn.resolve(cwd, args.cwd);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> checkPkg(cwd);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkPkg</span>(<span class="params">path</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> pkgPath = pathFn.join(path, <span class="string">'package.json'</span>);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> fs.readFile(pkgPath).then(<span class="function"><span class="keyword">function</span>(<span class="params">content</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> json = <span class="built_in">JSON</span>.parse(content);</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> json.hexo === <span class="string">'object'</span>) <span class="keyword">return</span> path;</div><div class="line">  &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err &amp;&amp; err.cause.code === <span class="string">'ENOENT'</span>) &#123;</div><div class="line">      <span class="keyword">var</span> parent = pathFn.dirname(path);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (parent === path) <span class="keyword">return</span>;</div><div class="line">      <span class="keyword">return</span> checkPkg(parent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> err;</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Then it loads the local hexo package.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadModule</span>(<span class="params">path, args</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.try(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> modulePath = pathFn.join(path, <span class="string">'node_modules'</span>, <span class="string">'hexo'</span>);</div><div class="line">    <span class="keyword">var</span> Hexo = <span class="built_in">require</span>(modulePath);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Hexo(path, args);</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p><code>new</code> a <code>Hexo</code> object. The souce code of <code>Hexo</code> is as follows:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Hexo</span>(<span class="params">base, args</span>) </span>&#123;</div><div class="line">  base = base || process.cwd();</div><div class="line">  args = args || &#123;&#125;;</div><div class="line"></div><div class="line">  EventEmitter.call(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.base_dir = base + sep;</div><div class="line">  <span class="keyword">this</span>.public_dir = pathFn.join(base, <span class="string">'public'</span>) + sep;</div><div class="line">  <span class="keyword">this</span>.source_dir = pathFn.join(base, <span class="string">'source'</span>) + sep;</div><div class="line">  <span class="keyword">this</span>.plugin_dir = pathFn.join(base, <span class="string">'node_modules'</span>) + sep;</div><div class="line">  <span class="keyword">this</span>.script_dir = pathFn.join(base, <span class="string">'scripts'</span>) + sep;</div><div class="line">  <span class="keyword">this</span>.scaffold_dir = pathFn.join(base, <span class="string">'scaffolds'</span>) + sep;</div><div class="line">  <span class="keyword">this</span>.theme_dir = pathFn.join(base, <span class="string">'themes'</span>, defaultConfig.theme) + sep;</div><div class="line">  <span class="keyword">this</span>.theme_script_dir = pathFn.join(<span class="keyword">this</span>.theme_dir, <span class="string">'scripts'</span>) + sep;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.env = &#123;</div><div class="line">    <span class="attr">args</span>: args,</div><div class="line">    <span class="attr">debug</span>: <span class="built_in">Boolean</span>(args.debug),</div><div class="line">    <span class="attr">safe</span>: <span class="built_in">Boolean</span>(args.safe),</div><div class="line">    <span class="attr">silent</span>: <span class="built_in">Boolean</span>(args.silent),</div><div class="line">    <span class="attr">env</span>: process.env.NODE_ENV || <span class="string">'development'</span>,</div><div class="line">    <span class="attr">version</span>: pkg.version,</div><div class="line">    <span class="attr">init</span>: <span class="literal">false</span></div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.config_path = args.config ? pathFn.resolve(base, args.config)</div><div class="line">                                 : pathFn.join(base, <span class="string">'_config.yml'</span>);</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.extend = &#123;</div><div class="line">    <span class="attr">console</span>: <span class="keyword">new</span> extend.Console(),</div><div class="line">    <span class="attr">deployer</span>: <span class="keyword">new</span> extend.Deployer(),</div><div class="line">    <span class="attr">filter</span>: <span class="keyword">new</span> extend.Filter(),</div><div class="line">    <span class="attr">generator</span>: <span class="keyword">new</span> extend.Generator(),</div><div class="line">    <span class="attr">helper</span>: <span class="keyword">new</span> extend.Helper(),</div><div class="line">    <span class="attr">migrator</span>: <span class="keyword">new</span> extend.Migrator(),</div><div class="line">    <span class="attr">processor</span>: <span class="keyword">new</span> extend.Processor(),</div><div class="line">    <span class="attr">renderer</span>: <span class="keyword">new</span> extend.Renderer(),</div><div class="line">    <span class="attr">tag</span>: <span class="keyword">new</span> extend.Tag()</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.config = _.cloneDeep(defaultConfig);</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.log = logger(<span class="keyword">this</span>.env);</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.render = <span class="keyword">new</span> Render(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.route = <span class="keyword">new</span> Router();</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.post = <span class="keyword">new</span> Post(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.scaffold = <span class="keyword">new</span> Scaffold(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">  <span class="keyword">this</span>._dbLoaded = <span class="literal">false</span>;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>._isGenerating = <span class="literal">false</span>;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.database = <span class="keyword">new</span> Database(&#123;</div><div class="line">    <span class="attr">version</span>: dbVersion,</div><div class="line">    <span class="attr">path</span>: pathFn.join(base, <span class="string">'db.json'</span>)</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  registerModels(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.source = <span class="keyword">new</span> Source(<span class="keyword">this</span>);</div><div class="line">  <span class="keyword">this</span>.theme = <span class="keyword">new</span> Theme(<span class="keyword">this</span>);</div><div class="line">  <span class="keyword">this</span>.locals = <span class="keyword">new</span> Locals(<span class="keyword">this</span>);</div><div class="line">  <span class="keyword">this</span>._bindLocals();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Hexo</code> gets several directories such as <code>public_dir</code>, <code>source_dir</code>, etc. Then it defines the <code>this.extend</code> object, which contains <code>console</code>, <code>deployer</code>, etc. The format of each instance in the <code>this.extend</code> object is as follows:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Console</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</div><div class="line">  <span class="keyword">this</span>.alias = &#123;&#125;;</div><div class="line">&#125;</div><div class="line"><span class="comment">//-------------------------</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Deployer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</div><div class="line">&#125;</div><div class="line"><span class="comment">//-------------------------</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Filter</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</div><div class="line">&#125;</div><div class="line"><span class="comment">//-------------------------</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Generator</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.id = <span class="number">0</span>;</div><div class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</div><div class="line">&#125;</div><div class="line"><span class="comment">//-------------------------</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Helper</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</div><div class="line">&#125;</div><div class="line"><span class="comment">//-------------------------</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Migrator</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</div><div class="line">&#125;</div><div class="line"><span class="comment">//-------------------------</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Processor</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.store = [];</div><div class="line">&#125;</div><div class="line"><span class="comment">//-------------------------</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Renderer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</div><div class="line">  <span class="keyword">this</span>.storeSync = &#123;&#125;;</div><div class="line">&#125;</div><div class="line"><span class="comment">//-------------------------</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Tag</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.env = <span class="keyword">new</span> nunjucks.Environment(<span class="literal">null</span>, &#123;</div><div class="line">    <span class="attr">autoescape</span>: <span class="literal">false</span></div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"><span class="comment">//-------------------------</span></div></pre></td></tr></table></figure>
<p>All of them contain the same object <code>this.store</code>, which is used to map the name to the corresponding function. For example, <code>this.store</code> in <code>Console</code> is as follows:</p>
<p><img src="http://i.imgur.com/fB0X6I3.png" alt="this.store"></p>
<p>Each key in the object such as <code>clean</code>, <code>config</code> is of type string. What they are mapped to are functions that implement them.</p>
<p>Then it creates several instances, <code>logger</code>, <code>Render</code>, <code>Router</code>, <code>Post</code>, <code>Scaffold</code>, <code>database</code> etc. <code>logger</code> is used to log information on the console and the file, <code>Render</code> is used to render files(e.g. render markdownf files to html), <code>Router</code> is used to save all paths used in the site, <code>Post</code> is used to //TODO, <code>Scaffold</code> is used to //TODO, <code>database</code> is a <a href="https://github.com/tommy351/warehouse" target="_blank" rel="external">JSON-based database</a>.</p>
<p>It then registered following schemas using <code>registerModels(this)</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">exports.Asset = <span class="built_in">require</span>(<span class="string">'./asset'</span>);</div><div class="line">exports.Cache = <span class="built_in">require</span>(<span class="string">'./cache'</span>);</div><div class="line">exports.Category = <span class="built_in">require</span>(<span class="string">'./category'</span>);</div><div class="line">exports.Data = <span class="built_in">require</span>(<span class="string">'./data'</span>);</div><div class="line">exports.Page = <span class="built_in">require</span>(<span class="string">'./page'</span>);</div><div class="line">exports.Post = <span class="built_in">require</span>(<span class="string">'./post'</span>);</div><div class="line">exports.PostAsset = <span class="built_in">require</span>(<span class="string">'./post_asset'</span>);</div><div class="line">exports.PostCategory = <span class="built_in">require</span>(<span class="string">'./post_category'</span>);</div><div class="line">exports.PostTag = <span class="built_in">require</span>(<span class="string">'./post_tag'</span>);</div><div class="line">exports.Tag = <span class="built_in">require</span>(<span class="string">'./tag'</span>);</div></pre></td></tr></table></figure>
<p>Afterwards, two instances are initiated, <code>Source</code>, <code>Theme</code>,which represents <code>source</code> and <code>theme</code> folders respectively. They are both being processed by <code>Box</code>.</p>
<p>First, let’s look at <code>source</code>.js.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> Box = <span class="built_in">require</span>(<span class="string">'../box'</span>);</div><div class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Source</span>(<span class="params">ctx</span>) </span>&#123;</div><div class="line">  Box.call(<span class="keyword">this</span>, ctx, ctx.source_dir);</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.processors = ctx.extend.processor.list();</div><div class="line">&#125;</div><div class="line"></div><div class="line">util.inherits(Source, Box);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = Source;</div></pre></td></tr></table></figure>
<p><code>ctx</code> refers to <code>Hexo</code>, <code>Source</code> function calls <code>Box</code> and gets the processor list, then it inherits <code>Box</code>. <code>Box</code> is used to read and render files in <code>source</code> or <code>theme</code> folder. To find out what’s going on, we need to look into the source code of <code>Box</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Box</span>(<span class="params">ctx, base, options</span>) </span>&#123;</div><div class="line">  EventEmitter.call(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.options = _.assign(&#123;</div><div class="line">    <span class="attr">persistent</span>: <span class="literal">true</span></div><div class="line">  &#125;, options);</div><div class="line"></div><div class="line">  <span class="comment">// if the last character of the working directory </span></div><div class="line">  <span class="comment">// is not /, add it to the end of base</span></div><div class="line">  <span class="keyword">if</span> (base.substring(base.length - <span class="number">1</span>) !== sep) &#123;</div><div class="line">    base += sep;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.context = ctx;</div><div class="line">  <span class="keyword">this</span>.base = base;</div><div class="line">  <span class="keyword">this</span>.processors = [];</div><div class="line">  <span class="keyword">this</span>._processingFiles = &#123;&#125;;</div><div class="line">  <span class="keyword">this</span>.watcher = <span class="literal">null</span>;</div><div class="line">  <span class="keyword">this</span>.Cache = ctx.model(<span class="string">'Cache'</span>);</div><div class="line">  <span class="keyword">this</span>.File = <span class="keyword">this</span>._createFileClass();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>It sets several variables, then it gets the <code>Cache</code> model. The source code of <code>ctx.model</code> function is as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">  Hexo.prototype.model = <span class="function"><span class="keyword">function</span>(<span class="params">name, schema</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.database.model(name, schema);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>If the model was created before, <code>this.database.model</code> will just return the model, or it will create the model with the specified <code>name</code> and <code>schema</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Database.prototype.model = <span class="function"><span class="keyword">function</span>(<span class="params">name, schema</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._models[name]) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._models[name];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> model = <span class="keyword">this</span>._models[name] = <span class="keyword">new</span> <span class="keyword">this</span>.Model(name, schema);</div><div class="line">  <span class="keyword">return</span> model;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Note that We have created the model in the <code>register_model</code> function, which is located in the <code>Hexo</code> function. When the code <code>new Hexo</code> is run, all the models are registered.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> models = <span class="built_in">require</span>(<span class="string">'../models'</span>);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> db = ctx.database;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> keys = <span class="built_in">Object</span>.keys(models);</div><div class="line">  <span class="keyword">var</span> key = <span class="string">''</span>;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = keys.length; i &lt; len; i++) &#123;</div><div class="line">    key = keys[i];</div><div class="line">    db.model(key, models[key](ctx));</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>The models created here were as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line">exports.Asset = <span class="built_in">require</span>(<span class="string">'./asset'</span>);</div><div class="line">exports.Cache = <span class="built_in">require</span>(<span class="string">'./cache'</span>);</div><div class="line">exports.Category = <span class="built_in">require</span>(<span class="string">'./category'</span>);</div><div class="line">exports.Data = <span class="built_in">require</span>(<span class="string">'./data'</span>);</div><div class="line">exports.Page = <span class="built_in">require</span>(<span class="string">'./page'</span>);</div><div class="line">exports.Post = <span class="built_in">require</span>(<span class="string">'./post'</span>);</div><div class="line">exports.PostAsset = <span class="built_in">require</span>(<span class="string">'./post_asset'</span>);</div><div class="line">exports.PostCategory = <span class="built_in">require</span>(<span class="string">'./post_category'</span>);</div><div class="line">exports.PostTag = <span class="built_in">require</span>(<span class="string">'./post_tag'</span>);</div><div class="line">exports.Tag = <span class="built_in">require</span>(<span class="string">'./tag'</span>);</div></pre></td></tr></table></figure>
<p>Which includes <code>cache</code>. So we can get the created <code>cache</code> model with <code>this.Cache = ctx.model(&#39;Cache&#39;);</code>. This model is used to cache generated posts and stuff, and store a hashed value for all of them. If the hash value is identical, hexo will not generate the post again, which reduces the generation time to a degree.</p>
<p>Now we only have a line left in the <code>box</code> function.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.File = <span class="keyword">this</span>._createFileClass();</div></pre></td></tr></table></figure>
<p><code>this.File</code> is used to read file contents and render it. The source code of <code>_createFileClass()</code> function is as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">Box.prototype._createFileClass = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">//ctx is Hexo</span></div><div class="line">  <span class="keyword">var</span> ctx = <span class="keyword">this</span>.context;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> _File = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">    File.call(<span class="keyword">this</span>, data);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="built_in">require</span>(<span class="string">'util'</span>).inherits(_File, File);</div><div class="line"></div><div class="line">  _File.prototype.box = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">  _File.prototype.render = <span class="function"><span class="keyword">function</span>(<span class="params">options, callback</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!callback &amp;&amp; <span class="keyword">typeof</span> options === <span class="string">'function'</span>) &#123;</div><div class="line">      callback = options;</div><div class="line">      options = &#123;&#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ctx.render.render(&#123;</div><div class="line">      <span class="attr">path</span>: <span class="keyword">this</span>.source</div><div class="line">    &#125;, options).asCallback(callback);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  _File.prototype.renderSync = <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> ctx.render.renderSync(&#123;</div><div class="line">      <span class="attr">path</span>: <span class="keyword">this</span>.source</div><div class="line">    &#125;, options);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> _File;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>File.call(this, data)</code> sets <code>_File</code>‘s <code>source</code>, <code>path</code>, <code>params</code> and <code>type</code> as the same as ones in <code>data</code>. You can see it in the source of the <code>File</code> constructor.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">File</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.source = data.source;</div><div class="line">  <span class="keyword">this</span>.path = data.path;</div><div class="line">  <span class="keyword">this</span>.params = data.params;</div><div class="line">  <span class="keyword">this</span>.type = data.type;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>_File</code> inherits <code>File</code> afterwards. Then it sets <code>render</code> and <code>renderSync</code> function of <code>_File</code> and returns it. As you can tell from their names, they are used to render files or strings, like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">hexo.render.render(&#123;<span class="attr">text</span>: <span class="string">'example'</span>, <span class="attr">engine</span>: <span class="string">'swig'</span>&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>&#123;</div><div class="line">  <span class="comment">// ...</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">hexo.render.render(&#123;<span class="attr">path</span>: <span class="string">'path/to/file.swig'</span>&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>&#123;</div><div class="line">  <span class="comment">// ...</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="Render"><a href="#Render" class="headerlink" title="Render"></a>Render</h2><p>Let’s look into the <code>Render</code> object.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Render</span>(<span class="params">ctx</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.context = ctx;</div><div class="line">  <span class="keyword">this</span>.renderer = ctx.extend.renderer;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Still remember <code>renderer</code>? It’s used to store all the information about rendering.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Renderer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</div><div class="line">  <span class="keyword">this</span>.storeSync = &#123;&#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The most important function in <code>render.js</code> is <code>Render.prototype.render</code>, the function is used to render text or files, the source code of it is as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">Render.prototype.render = <span class="function"><span class="keyword">function</span>(<span class="params">data, options, callback</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!callback &amp;&amp; <span class="keyword">typeof</span> options === <span class="string">'function'</span>) &#123;</div><div class="line">    callback = options;</div><div class="line">    options = &#123;&#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> ctx = <span class="keyword">this</span>.context;</div><div class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">  <span class="keyword">var</span> ext = <span class="string">''</span>;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!data) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'No input file or string!'</span>));</div><div class="line">    <span class="keyword">if</span> (data.text != <span class="literal">null</span>) <span class="keyword">return</span> resolve(data.text);</div><div class="line">    <span class="keyword">if</span> (!data.path) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'No input file or string!'</span>));</div><div class="line"></div><div class="line">    fs.readFile(data.path).then(resolve, reject);</div><div class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">text</span>) </span>&#123;</div><div class="line">    data.text = text;</div><div class="line">    ext = data.engine || getExtname(data.path);</div><div class="line">    <span class="keyword">if</span> (!ext || !self.isRenderable(ext)) <span class="keyword">return</span> text;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> renderer = self.getRenderer(ext);</div><div class="line">    <span class="keyword">return</span> renderer.call(ctx, data, options);</div><div class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</div><div class="line">    result = toString(result, data);</div><div class="line">    <span class="keyword">if</span> (data.onRenderEnd) &#123;</div><div class="line">      <span class="keyword">return</span> data.onRenderEnd(result);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> output = self.getOutput(ext) || ext;</div><div class="line">    <span class="keyword">return</span> ctx.execFilter(<span class="string">'after_render:'</span> + output, result, &#123;</div><div class="line">      <span class="attr">context</span>: ctx,</div><div class="line">      <span class="attr">args</span>: [data]</div><div class="line">    &#125;);</div><div class="line">  &#125;).asCallback(callback);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li><p>First, it checks if <code>data</code> exists or not, <code>data</code> contains text(<code>data.text</code>) or file(<code>data.path</code>) that is going to be rendered, it throws an error if it doesn’t exist.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!data) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'No input file or string!'</span>));</div></pre></td></tr></table></figure>
</li>
<li><p>Then if <code>data.text</code> exists, it will try to render the text first.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (data.text != <span class="literal">null</span>) <span class="keyword">return</span> resolve(data.text);</div></pre></td></tr></table></figure>
</li>
<li><p>If <code>data.path</code> exists, it will try to analyze the file specified by <code>data.path</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!data.path) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'No input file or string!'</span>));</div><div class="line">fs.readFile(data.path).then(resolve, reject);</div></pre></td></tr></table></figure>
</li>
<li><p>It tries to find out if the rendering engine exists in <code>renderer.store</code>, which maps the rendering engine’s name to the corresponding rendering function. If the engine exists, it will call the corresponding function to render it, return the original text if the engine doesn’t exist.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">text</span>) </span>&#123;</div><div class="line">data.text = text;</div><div class="line">ext = data.engine || getExtname(data.path);</div><div class="line"><span class="keyword">if</span> (!ext || !self.isRenderable(ext)) <span class="keyword">return</span> text;</div><div class="line"></div><div class="line"><span class="comment">// get the function used to render</span></div><div class="line"><span class="keyword">var</span> renderer = self.getRenderer(ext);</div><div class="line"><span class="keyword">return</span> renderer.call(ctx, data, options);</div></pre></td></tr></table></figure>
<p><code>renderer</code> refers to the function that is used to render text or files. What <code>renderer.call()</code> returns is usually of JSON format. For example, if the file to be rendered is like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">archive_dir: archives</div><div class="line">author: John Doe</div></pre></td></tr></table></figure>
<p>The rendered result will be an object like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">archive_dir</span>: <span class="string">"archives"</span>, <span class="attr">author</span>: <span class="string">"John Doe"</span>&#125;</div></pre></td></tr></table></figure>
<p>Some files are not rendered in this way, e.g. <code>md</code>. The rendering results of markdown files are of type string. <code>Hexo</code> creates a <code>toString</code> function to make the conversion happen.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result = toString(result, data);</div></pre></td></tr></table></figure>
<p>The source code of <code>toString</code> function is as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">toString</span>(<span class="params">result, options</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!options.hasOwnProperty(<span class="string">'toString'</span>) || <span class="keyword">typeof</span> result === <span class="string">'string'</span>) <span class="keyword">return</span> result;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> options.toString === <span class="string">'function'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> options.toString(result);</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> result === <span class="string">'object'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(result);</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.toString) &#123;</div><div class="line">    <span class="keyword">return</span> result.toString();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Because <code>md</code> files’s rendering results are of type string. so <code>toString</code> returns the original result directly in this case. Sometimes it needs to be further processed.</p>
<p>Afterwards, <code>onRenderEnd</code> is followed in order to modify some contents of <code>result</code> after rendering.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (data.onRenderEnd) &#123;</div><div class="line">  <span class="keyword">return</span> data.onRenderEnd(result);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Then the result is transferred to the next <code>then</code> function, and the <code>after_render</code> filter is executed.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</div><div class="line">  <span class="comment">// output is the file's final type, e.g. html, css</span></div><div class="line">  <span class="comment">// the result of self.getOutput('md') would be 'html',</span></div><div class="line">  <span class="comment">// because the rendering result of a markdown file is of type html</span></div><div class="line">  <span class="keyword">var</span> output = self.getOutput(ext) || ext;</div><div class="line">  <span class="keyword">return</span> ctx.execFilter(<span class="string">'after_render:'</span> + output, result, &#123;</div><div class="line">    <span class="attr">context</span>: ctx,</div><div class="line">    <span class="attr">args</span>: [data]</div><div class="line">  &#125;);</div><div class="line">&#125;).asCallback(callback);</div></pre></td></tr></table></figure>
<p>To make it even clearer about how to use <code>execFilter</code>, Here I give an example from the official Hexo website, the following code is used to uglify js files.</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> UglifyJS = <span class="built_in">require</span>(<span class="string">'uglify-js'</span>);</div><div class="line"></div><div class="line">hexo.extend.filter.register(<span class="string">'after_render:js'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">str, data</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> result = UglifyJS.minify(str);</div><div class="line">  <span class="keyword">return</span> result.code;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>This is the source code of <code>register</code> function.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Filter.prototype.register = <span class="function"><span class="keyword">function</span>(<span class="params">type, fn, priority</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!priority) &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> type === <span class="string">'function'</span>) &#123;</div><div class="line">      priority = fn;</div><div class="line">      fn = type;</div><div class="line">      type = <span class="string">'after_post_render'</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'fn must be a function'</span>);</div><div class="line"></div><div class="line">  type = typeAlias[type] || type;</div><div class="line">  priority = priority == <span class="literal">null</span> ? <span class="number">10</span> : priority;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> store = <span class="keyword">this</span>.store[type] = <span class="keyword">this</span>.store[type] || [];</div><div class="line"></div><div class="line">  fn.priority = priority;</div><div class="line">  store.push(fn);</div><div class="line"></div><div class="line">  store.sort(<span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> a.priority - b.priority;</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>As you can see, it stores <code>type</code>(e.g. <code>after_post_render:js</code>) and the corresponding processing function in the <code>this.store</code> object. After the registration is over, <code>Filter.prototype.exec</code> executes the specified filter (<code>after_post_render:js</code> in this case).</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Filter.prototype.exec = <span class="function"><span class="keyword">function</span>(<span class="params">type, data, options</span>) </span>&#123;</div><div class="line">  options = options || &#123;&#125;;</div><div class="line"></div><div class="line">  <span class="comment">// filters are the functions that are registered before.</span></div><div class="line">  <span class="comment">// this.list(type) gets these functions from this.store</span></div><div class="line">  <span class="keyword">var</span> filters = <span class="keyword">this</span>.list(type);</div><div class="line">  <span class="keyword">var</span> ctx = options.context;</div><div class="line">  <span class="keyword">var</span> args = options.args || [];</div><div class="line"></div><div class="line">  args.unshift(data);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.each(filters, <span class="function"><span class="keyword">function</span>(<span class="params">filter</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.method(filter).apply(ctx, args).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</div><div class="line">      <span class="comment">/* when the processing is over, the processing function returns</span></div><div class="line">         the processed result, if the result equals null, it will return</div><div class="line">         the original one without processed by the filter(data), if the</div><div class="line">         result is not null, it will return the result processed by the</div><div class="line">         filter */</div><div class="line">      args[<span class="number">0</span>] = result == <span class="literal">null</span> ? data : result;</div><div class="line">      <span class="keyword">return</span> args[<span class="number">0</span>];</div><div class="line">    &#125;);</div><div class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> args[<span class="number">0</span>];</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>OK, this part is over, let’s look into the <code>theme/index.js</code> file next.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> pathFn = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</div><div class="line"><span class="keyword">var</span> Box = <span class="built_in">require</span>(<span class="string">'../box'</span>);</div><div class="line"><span class="keyword">var</span> View = <span class="built_in">require</span>(<span class="string">'./view'</span>);</div><div class="line"><span class="keyword">var</span> I18n = <span class="built_in">require</span>(<span class="string">'hexo-i18n'</span>);</div><div class="line"><span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Theme</span>(<span class="params">ctx</span>) </span>&#123;</div><div class="line">  Box.call(<span class="keyword">this</span>, ctx, ctx.theme_dir);</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.config = &#123;&#125;;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.views = &#123;&#125;;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.processors = [</div><div class="line">    <span class="built_in">require</span>(<span class="string">'./processors/config'</span>),</div><div class="line">    <span class="built_in">require</span>(<span class="string">'./processors/i18n'</span>),</div><div class="line">    <span class="built_in">require</span>(<span class="string">'./processors/source'</span>),</div><div class="line">    <span class="built_in">require</span>(<span class="string">'./processors/view'</span>)</div><div class="line">  ];</div><div class="line"></div><div class="line">  <span class="keyword">var</span> languages = ctx.config.language;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(languages)) &#123;</div><div class="line">    languages = [languages];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  languages.push(<span class="string">'default'</span>);</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.i18n = <span class="keyword">new</span> I18n(&#123;</div><div class="line">    <span class="attr">languages</span>: _(languages).compact().uniq().value()</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">var</span> _View = <span class="keyword">this</span>.View = <span class="function"><span class="keyword">function</span>(<span class="params">path, data</span>) </span>&#123;</div><div class="line">    View.call(<span class="keyword">this</span>, path, data);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  util.inherits(_View, View);</div><div class="line"></div><div class="line">  _View.prototype._theme = <span class="keyword">this</span>;</div><div class="line">  _View.prototype._render = ctx.render;</div><div class="line">  _View.prototype._helper = ctx.extend.helper;</div><div class="line">&#125;</div><div class="line"></div><div class="line">util.inherits(Theme, Box);</div></pre></td></tr></table></figure>
<p>The function <code>Theme</code> also calls <code>Box()</code>, then it adds several processors and sets languages and views.</p>
<p>Then it bind locals.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">  Hexo.prototype._bindLocals = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> db = <span class="keyword">this</span>.database;</div><div class="line">  <span class="keyword">var</span> locals = <span class="keyword">this</span>.locals;</div><div class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">  locals.set(<span class="string">'posts'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> query = &#123;&#125;;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!self.config.future) &#123;</div><div class="line">      query.date = &#123;<span class="attr">$lte</span>: <span class="built_in">Date</span>.now()&#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!self._showDrafts()) &#123;</div><div class="line">      query.published = <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> db.model(<span class="string">'Post'</span>).find(query);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  locals.set(<span class="string">'pages'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> query = &#123;&#125;;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!self.config.future) &#123;</div><div class="line">      query.date = &#123;<span class="attr">$lte</span>: <span class="built_in">Date</span>.now()&#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> db.model(<span class="string">'Page'</span>).find(query);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  locals.set(<span class="string">'categories'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> db.model(<span class="string">'Category'</span>);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  locals.set(<span class="string">'tags'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> db.model(<span class="string">'Tag'</span>);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  locals.set(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> obj = &#123;&#125;;</div><div class="line"></div><div class="line">    db.model(<span class="string">'Data'</span>).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">      obj[data._id] = data.data;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
</li>
</ul>
<ol>
<li><p>After loading module is over, it calls <code>console</code> to execute the provided command</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> loadModule(path, args).catch(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    log.error(<span class="string">'Local hexo not found in %s'</span>, chalk.magenta(tildify(path)));</div><div class="line">    log.error(<span class="string">'Try running: \'npm install hexo --save\''</span>);</div><div class="line">    process.exit(<span class="number">2</span>);</div><div class="line">  &#125;);</div><div class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">mod</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (mod) hexo = mod;</div><div class="line">  log = hexo.log;</div><div class="line"></div><div class="line">  <span class="built_in">require</span>(<span class="string">'./console'</span>)(hexo);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> hexo.init();</div></pre></td></tr></table></figure>
</li>
</ol>
<p>  Let’s look through the source code of <code>./console</code>.</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> <span class="built_in">console</span> = ctx.extend.console;</div><div class="line"></div><div class="line">  <span class="built_in">console</span>.register(<span class="string">'help'</span>, <span class="string">'Get help on a command.'</span>, &#123;</div><div class="line">  &#125;, <span class="built_in">require</span>(<span class="string">'./help'</span>));</div><div class="line"></div><div class="line">  <span class="built_in">console</span>.register(<span class="string">'init'</span>, <span class="string">'Create a new Hexo folder.'</span>, &#123;</div><div class="line">  <span class="attr">desc</span>: <span class="string">'Create a new Hexo folder at the specified path or the current directory.'</span>,</div><div class="line">  <span class="attr">usage</span>: <span class="string">'[destination]'</span>,</div><div class="line">  <span class="attr">arguments</span>: [</div><div class="line">    &#123;<span class="attr">name</span>: <span class="string">'destination'</span>, <span class="attr">desc</span>: <span class="string">'Folder path. Initialize in current folder if not specified'</span>&#125;</div><div class="line">  ],</div><div class="line">  <span class="attr">options</span>: [</div><div class="line">    &#123;<span class="attr">name</span>: <span class="string">'--no-clone'</span>, <span class="attr">desc</span>: <span class="string">'Copy files instead of cloning from GitHub'</span>&#125;,</div><div class="line">    &#123;<span class="attr">name</span>: <span class="string">'--no-install'</span>, <span class="attr">desc</span>: <span class="string">'Skip npm install'</span>&#125;</div><div class="line">  ]</div><div class="line">  &#125;, <span class="built_in">require</span>(<span class="string">'./init'</span>));</div><div class="line"></div><div class="line">  <span class="built_in">console</span>.register(<span class="string">'version'</span>, <span class="string">'Display version information.'</span>, &#123;</div><div class="line">  &#125;, <span class="built_in">require</span>(<span class="string">'./version'</span>));</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>  It registers several commands using <code>console.register</code>, let’s look through its source code.</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">Console.prototype.register = <span class="function"><span class="keyword">function</span>(<span class="params">name, desc, options, fn</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!name) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'name is required'</span>);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!fn) &#123;</div><div class="line">    <span class="keyword">if</span> (options) &#123;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) &#123;</div><div class="line">        fn = options;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> desc === <span class="string">'object'</span>) &#123; <span class="comment">// name, options, fn</span></div><div class="line">          options = desc;</div><div class="line">          desc = <span class="string">''</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// name, desc, fn</span></div><div class="line">          options = &#123;&#125;;</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'fn must be a function'</span>);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">// name, fn</span></div><div class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> desc === <span class="string">'function'</span>) &#123;</div><div class="line">        fn = desc;</div><div class="line">        options = &#123;&#125;;</div><div class="line">        desc = <span class="string">''</span>;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'fn must be a function'</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (fn.length &gt; <span class="number">1</span>) &#123;</div><div class="line">    fn = <span class="built_in">Promise</span>.promisify(fn);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    fn = <span class="built_in">Promise</span>.method(fn);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> c = <span class="keyword">this</span>.store[name.toLowerCase()] = fn;</div><div class="line">  c.options = options;</div><div class="line">  c.desc = desc;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.alias = abbrev(<span class="built_in">Object</span>.keys(<span class="keyword">this</span>.store));</div><div class="line">&#125;;</div></pre></td></tr></table></figure>

        </div>
        <footer class="article-footer">
            



    <a data-url="http://searene.me/2016/07/17/Hexo-Source-Code-Demystified/" data-id="cjjhacqdb00298arfpzhr0vup" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>

                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>follow:</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/searene" target="_blank">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="stack-overflow" href="https://stackoverflow.com/users/1031769/searene?tab=profile" target="_blank">
                        <i class="icon fa fa-stack-overflow"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="http://feeds.feedburner.com/Searene" target="_blank">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2016/09/30/Calculate-1-lambda-n-n/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">newer</strong>
        <p class="article-nav-title">
        
            Calculate $$\lim\limits_{n\to\infty}(1-\frac{\lambda_n}n)^n$$
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2016/07/04/The-fee-paid-to-freelancer-is-not-refundable/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">older</strong>
        <p class="article-nav-title">The fee paid to freelancer is not refundable</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap">
        <h3 class="widget-title">recents</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/04/07/Went-to-Qiandao-Lake/" class="thumbnail">
    
    
        <span style="background-image:url(/images/IMG_20180406_084153.jpg)" alt="Went to Qiandao Lake" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Journal/">Journal</a></p>
                            <p class="item-title"><a href="/2018/04/07/Went-to-Qiandao-Lake/" class="title">Went to Qiandao Lake</a></p>
                            <p class="item-date"><time datetime="2018-04-07T02:48:09.000Z" itemprop="datePublished">2018-04-07</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/04/03/Go-to-KTV-alone/" class="thumbnail">
    
    
        <span style="background-image:url(/images/1_1354265864.jpg)" alt="Go to KTV alone" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Journal/">Journal</a></p>
                            <p class="item-title"><a href="/2018/04/03/Go-to-KTV-alone/" class="title">Go to KTV alone</a></p>
                            <p class="item-date"><time datetime="2018-04-02T23:10:10.000Z" itemprop="datePublished">2018-04-03</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/04/01/live-a-quite-life/" class="thumbnail">
    
    
        <span style="background-image:url(/images/8608094661_f6fdcc0c83_b.jpg)" alt="live a quite life" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Journal/">Journal</a></p>
                            <p class="item-title"><a href="/2018/04/01/live-a-quite-life/" class="title">live a quite life</a></p>
                            <p class="item-date"><time datetime="2018-04-01T01:50:26.000Z" itemprop="datePublished">2018-04-01</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/03/05/The-meaning-of-life/" class="thumbnail">
    
    
        <span style="background-image:url(/images/980x.png)" alt="The meaning of life" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Journal/">Journal</a></p>
                            <p class="item-title"><a href="/2018/03/05/The-meaning-of-life/" class="title">The meaning of life</a></p>
                            <p class="item-date"><time datetime="2018-03-05T10:53:53.000Z" itemprop="datePublished">2018-03-05</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/01/20/We-are-either-young-or-old-never-something-in-between/" class="thumbnail">
    
    
        <span style="background-image:url(/images/128910133_14610369084721n.jpg)" alt="We are either young or old, never something in between" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Journey/">Journey</a></p>
                            <p class="item-title"><a href="/2018/01/20/We-are-either-young-or-old-never-something-in-between/" class="title">We are either young or old, never something in between</a></p>
                            <p class="item-date"><time datetime="2018-01-20T07:55:01.000Z" itemprop="datePublished">2018-01-20</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Coding/">Coding</a><span class="category-list-count">48</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Journal/">Journal</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Journey/">Journey</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Math/">Math</a><span class="category-list-count">5</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">14</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Big-Data/">Big Data</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-Scala/">Java, Scala</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/">Kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Neural-Network/">Neural Network</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scala/">Scala</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/">algorithm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/anki/">anki</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/book/">book</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chrome/">chrome</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/composition/">composition</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/">django</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dnsmasq/">dnsmasq</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/encoding/">encoding</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fcitx/">fcitx</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/firefox/">firefox</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hadoop/">hadoop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hueman/">hueman</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/i3/">i3</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/">jvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/">kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/">leetcode</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/">life</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/limit/">limit</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/machine-learning/">machine learning</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/math/">math</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mathjax/">mathjax</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/multi-thread-java-scala/">multi-thread, java, scala</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysqldb/">mysqldb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">network</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/poisson/">poisson</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/probability/">probability</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/proof/">proof</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pycharm/">pycharm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/set-thoery/">set-thoery</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sublime/">sublime</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/">ubuntu</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtualbox/">virtualbox</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/win7/">win7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zsh/">zsh</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/Big-Data/" style="font-size: 10px;">Big Data</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Java-Scala/" style="font-size: 10px;">Java, Scala</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/Neural-Network/" style="font-size: 10px;">Neural Network</a> <a href="/tags/Scala/" style="font-size: 12px;">Scala</a> <a href="/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/tags/anki/" style="font-size: 16px;">anki</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/chrome/" style="font-size: 10px;">chrome</a> <a href="/tags/composition/" style="font-size: 10px;">composition</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/dnsmasq/" style="font-size: 10px;">dnsmasq</a> <a href="/tags/encoding/" style="font-size: 10px;">encoding</a> <a href="/tags/fcitx/" style="font-size: 12px;">fcitx</a> <a href="/tags/firefox/" style="font-size: 10px;">firefox</a> <a href="/tags/git/" style="font-size: 12px;">git</a> <a href="/tags/hadoop/" style="font-size: 10px;">hadoop</a> <a href="/tags/hexo/" style="font-size: 14px;">hexo</a> <a href="/tags/hueman/" style="font-size: 10px;">hueman</a> <a href="/tags/i3/" style="font-size: 10px;">i3</a> <a href="/tags/java/" style="font-size: 16px;">java</a> <a href="/tags/javascript/" style="font-size: 14px;">javascript</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/kafka/" style="font-size: 10px;">kafka</a> <a href="/tags/leetcode/" style="font-size: 10px;">leetcode</a> <a href="/tags/life/" style="font-size: 10px;">life</a> <a href="/tags/limit/" style="font-size: 12px;">limit</a> <a href="/tags/linux/" style="font-size: 20px;">linux</a> <a href="/tags/machine-learning/" style="font-size: 10px;">machine learning</a> <a href="/tags/math/" style="font-size: 14px;">math</a> <a href="/tags/mathjax/" style="font-size: 10px;">mathjax</a> <a href="/tags/multi-thread-java-scala/" style="font-size: 10px;">multi-thread, java, scala</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/mysqldb/" style="font-size: 10px;">mysqldb</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/poisson/" style="font-size: 10px;">poisson</a> <a href="/tags/probability/" style="font-size: 10px;">probability</a> <a href="/tags/proof/" style="font-size: 10px;">proof</a> <a href="/tags/pycharm/" style="font-size: 10px;">pycharm</a> <a href="/tags/python/" style="font-size: 18px;">python</a> <a href="/tags/set-thoery/" style="font-size: 10px;">set-thoery</a> <a href="/tags/shell/" style="font-size: 12px;">shell</a> <a href="/tags/sublime/" style="font-size: 10px;">sublime</a> <a href="/tags/ubuntu/" style="font-size: 14px;">ubuntu</a> <a href="/tags/vim/" style="font-size: 14px;">vim</a> <a href="/tags/virtualbox/" style="font-size: 10px;">virtualbox</a> <a href="/tags/win7/" style="font-size: 10px;">win7</a> <a href="/tags/zsh/" style="font-size: 10px;">zsh</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2018 Searene</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'searene';
    
    
    var disqus_url = 'http://searene.me/2016/07/17/Hexo-Source-Code-Demystified/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>



    
        <script src="/vendor/fancybox/jquery.fancybox.pack.js"></script>
    

    
        <script src="/vendor/scrollLoading/jquery.scrollLoading.js"></script>
        <script src="/vendor/scrollLoading/main.js"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js"></script>
</script>

        <!-- mathjax config similar to math.stackexchange -->

<script type="text/javascript">
$(document).ready(function(){
  $("code").map(function(){
    match = /^\$(.*)\$$/.exec($(this).html());
    if (match){
      //$(this).after("<span class=mathjax_inline>" + match + "</span>");
      //$(this).hide();
      $(this).replaceWith("<span class=hpl_mathjax_inline>" + $(this).html() + "</span>");
      MathJax.Hub.Queue(["Typeset",MathJax.Hub,$(this).get(0)]);
    }
  });
});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

    </div>
</body>
</html>
