<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-2396877498000532",
    enable_page_level_ads: true
  });
</script>
    
    <title>Hexo Source Code Demystified | Searene</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content>
    
    <meta name="description" content="PrefaceHexo is an excellent static blog generator, I read its source code recently, and I think it’s worth sharing the inner mechanism of its source code. GeneratorWhen you run the command hexo genera">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo Source Code Demystified">
<meta property="og:url" content="https://searene.github.io/2016/07/17/Hexo-Source-Code-Demystified/index.html">
<meta property="og:site_name" content="Searene">
<meta property="og:description" content="PrefaceHexo is an excellent static blog generator, I read its source code recently, and I think it’s worth sharing the inner mechanism of its source code. GeneratorWhen you run the command hexo genera">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://i.imgur.com/fB0X6I3.png">
<meta property="og:updated_time" content="2016-12-06T14:08:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo Source Code Demystified">
<meta name="twitter:description" content="PrefaceHexo is an excellent static blog generator, I read its source code recently, and I think it’s worth sharing the inner mechanism of its source code. GeneratorWhen you run the command hexo genera">
<meta name="twitter:image" content="http://i.imgur.com/fB0X6I3.png">
    

    

    

    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/vendor/titillium-web/styles.css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/vendor/jquery/2.0.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/vendor/fancybox/jquery.fancybox.css">
    
    
        <link rel="stylesheet" href="/vendor/scrollLoading/style.css">
    
    
        <script type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-71019366-1', 'auto');
ga('send', 'pageview');

</script>
    
    

</head>
</html>
<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item">
                                    <a class="main-nav-list-link" href="/">Home</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Coding/">Coding</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Journal/">Journal</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Journey/">Journey</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Life/">Life</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Math/">Math</a></li></ul>
                                    
                                <li class="main-nav-list-item">
                                    <a class="main-nav-list-link" href="/about/index.html">About</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Coding/">Coding</a>
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-Hexo-Source-Code-Demystified" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        Hexo Source Code Demystified
        </h1>
    

            </header>
        
        <div class="article-subtitle">
            <a href="/2016/07/17/Hexo-Source-Code-Demystified/" class="article-date">
    <time datetime="2016-07-16T23:52:23.000Z" itemprop="datePublished">2016-07-17</time>
</a>
            
        </div>
        <div class="article-entry" itemprop="articleBody">
            <h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p>Hexo is an excellent static blog generator, I read its source code recently, and I think it’s worth sharing the inner mechanism of its source code.</p>
<h1 id="Generator"><a href="#Generator" class="headerlink" title="Generator"></a>Generator</h1><p>When you run the command <code>hexo generate</code>, hexo will generate all the static files for you. This is the part we are going to start with. The directory where <code>hexo generate</code> is executed is <code>/home/searene/Development/hexo-twenty-sixteen</code> in this tutorial.</p>
<p>First, we can find the location of the tool <code>hexo</code> with the command <code>which</code>.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">which hexo</span><br></pre></td></tr></table></figure>
<p>My output is</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/searene/.nvm/versions/node/v5.0.0/bin/hexo</span><br></pre></td></tr></table></figure>
<p>This is a soft link, we get the location of the original file with <code>ll</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ll ~/.nvm/versions/node/v5.0.0/bin/hexo </span><br><span class="line"></span><br><span class="line">lrwxrwxrwx 1 searene searene 37 May 24 01:15 /home/searene/.nvm/versions/node/v5.0.0/bin/hexo -&gt; ../lib/node_modules/hexo-cli/bin/hexo</span><br></pre></td></tr></table></figure>
<p>The contents of <code>hexo</code> are as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'../lib/hexo'</span>)();</span><br></pre></td></tr></table></figure>
<p>It requires a js file called <code>hexo</code>, which is located in <code>/home/searene/.nvm/versions/node/v5.0.0/lib/node_modules/hexo-cli/lib/hexo.js</code> in my case. The beginning part of the file is as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>);</span><br><span class="line"><span class="keyword">var</span> tildify = <span class="built_in">require</span>(<span class="string">'tildify'</span>);</span><br><span class="line"><span class="keyword">var</span> pathFn = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="built_in">require</span>(<span class="string">'bluebird'</span>);</span><br><span class="line"><span class="keyword">var</span> Context = <span class="built_in">require</span>(<span class="string">'./context'</span>);</span><br><span class="line"><span class="keyword">var</span> findPkg = <span class="built_in">require</span>(<span class="string">'./find_pkg'</span>);</span><br><span class="line"><span class="keyword">var</span> goodbye = <span class="built_in">require</span>(<span class="string">'./goodbye'</span>);</span><br><span class="line"><span class="keyword">var</span> minimist = <span class="built_in">require</span>(<span class="string">'minimist'</span>);</span><br><span class="line"><span class="keyword">var</span> camelCaseKeys = <span class="built_in">require</span>(<span class="string">'hexo-util/lib/camel_case_keys'</span>);</span><br></pre></td></tr></table></figure>
<p>It requires several packages.</p>
<ol>
<li><code>chalk</code> is used for colorful outputs,.</li>
<li><code>tildify</code> is used to convert an absolute path to a tilde path:, like <code>/Users/sindresorhus/dev</code> → <code>~/dev</code>.</li>
<li><code>context</code> is used to //TODO</li>
<li><code>find_pkg</code> is used to find the local hexo directory that contains <code>node_modules</code></li>
<li><code>goodbye</code> is used to generate a random goodbye sentence.</li>
<li><code>minimist</code> is used to parse argument options.</li>
<li><code>camelCaseKeys</code> is used to convert keys in parameters to the camelCased ones</li>
</ol>
<p>Let’s continue to read the file.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">entry</span>(<span class="params">cwd, args</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// cwd is the directory where you invoked the node command</span></span><br><span class="line">  cwd = cwd || process.cwd();</span><br><span class="line">  <span class="comment">// the keys in args is camelCased</span></span><br><span class="line">  args = camelCaseKeys(args || minimist(process.argv.slice(<span class="number">2</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> hexo = <span class="keyword">new</span> Context(cwd, args);</span><br><span class="line">  <span class="keyword">var</span> log = hexo.log;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Change the title in console</span></span><br><span class="line">  process.title = <span class="string">'hexo'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleError</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    log.fatal(err);</span><br><span class="line">    process.exit(<span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* findPkg searched upwards from the working directory(cwd) to</span></span><br><span class="line"><span class="comment">     find a directory containing package.json where the key hexo lies,</span></span><br><span class="line"><span class="comment">     a promise is returned by the function. */</span></span><br><span class="line">  <span class="keyword">return</span> findPkg(cwd, args).then(<span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!path) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* hexo.base_dir is set as the found directory, which is </span></span><br><span class="line"><span class="comment">       /home/searene/Development/hexo-twenty-sixteen */</span></span><br><span class="line">    hexo.base_dir = path;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* loadModule loads the hexo package located in the working</span></span><br><span class="line"><span class="comment">       directory(/home/searene/Development/hexo-twenty-sixteen)</span></span><br><span class="line"><span class="comment">       and returns a promise, the resolve function will carry a</span></span><br><span class="line"><span class="comment">       newly-constructed Hexo(return new Hexo(path, args)) object </span></span><br><span class="line"><span class="comment">       afterwards. From now on, local hexo will be used instead </span></span><br><span class="line"><span class="comment">       of the global one. */</span></span><br><span class="line">    <span class="keyword">return</span> loadModule(path, args).catch(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      log.error(<span class="string">'Local hexo not found in %s'</span>, chalk.magenta(tildify(path)));</span><br><span class="line">      log.error(<span class="string">'Try running: \'npm install hexo --save\''</span>);</span><br><span class="line">      process.exit(<span class="number">2</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">mod</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mod) hexo = mod;</span><br><span class="line">    log = hexo.log;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'./console'</span>)(hexo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hexo.init();</span><br><span class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> cmd = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!args.h &amp;&amp; !args.help) &#123;</span><br><span class="line">      cmd = args._.shift();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (cmd) &#123;</span><br><span class="line">        <span class="keyword">var</span> c = hexo.extend.console.get(cmd);</span><br><span class="line">        <span class="keyword">if</span> (!c) cmd = <span class="string">'help'</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cmd = <span class="string">'help'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cmd = <span class="string">'help'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    watchSignal(hexo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hexo.call(cmd, args).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> hexo.exit();</span><br><span class="line">    &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> hexo.exit(err).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        handleError(err);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;).catch(handleError);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">entry.console = &#123;</span><br><span class="line">  init: <span class="built_in">require</span>(<span class="string">'./console/init'</span>),</span><br><span class="line">  help: <span class="built_in">require</span>(<span class="string">'./console/help'</span>),</span><br><span class="line">  version: <span class="built_in">require</span>(<span class="string">'./console/version'</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">entry.version = <span class="built_in">require</span>(<span class="string">'../package.json'</span>).version;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadModule</span>(<span class="params">path, args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.try(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> modulePath = pathFn.join(path, <span class="string">'node_modules'</span>, <span class="string">'hexo'</span>);</span><br><span class="line">    <span class="keyword">var</span> Hexo = <span class="built_in">require</span>(modulePath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Hexo(path, args);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">watchSignal</span>(<span class="params">hexo</span>) </span>&#123;</span><br><span class="line">  process.on(<span class="string">'SIGINT'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    hexo.log.info(goodbye());</span><br><span class="line">    hexo.unwatch();</span><br><span class="line"></span><br><span class="line">    hexo.exit().then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      process.exit();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = entry;</span><br></pre></td></tr></table></figure>
<p>Notice the last part</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = entry;</span><br></pre></td></tr></table></figure>
<p>Remember the contents of <code>hexo.js</code>?</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'../lib/hexo'</span>)();</span><br></pre></td></tr></table></figure>
<p>So what <code>hexo.js</code> does is calling the <code>entry</code> function. Here comes the question, what does <code>entry</code> do?</p>
<ol>
<li><p>It searched upwards from the working directory looking for <code>package.json</code> containing the key <code>hexo</code>.</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findPkg</span>(<span class="params">cwd, args</span>) </span>&#123;</span><br><span class="line">  args = args || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (args.cwd) &#123;</span><br><span class="line">    cwd = pathFn.resolve(cwd, args.cwd);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> checkPkg(cwd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkPkg</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> pkgPath = pathFn.join(path, <span class="string">'package.json'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fs.readFile(pkgPath).then(<span class="function"><span class="keyword">function</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> json = <span class="built_in">JSON</span>.parse(content);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> json.hexo === <span class="string">'object'</span>) <span class="keyword">return</span> path;</span><br><span class="line">  &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err &amp;&amp; err.cause.code === <span class="string">'ENOENT'</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> parent = pathFn.dirname(path);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (parent === path) <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">return</span> checkPkg(parent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> err;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Then it loads the local hexo package.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadModule</span>(<span class="params">path, args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.try(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> modulePath = pathFn.join(path, <span class="string">'node_modules'</span>, <span class="string">'hexo'</span>);</span><br><span class="line">    <span class="keyword">var</span> Hexo = <span class="built_in">require</span>(modulePath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Hexo(path, args);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>new</code> a <code>Hexo</code> object. The souce code of <code>Hexo</code> is as follows:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Hexo</span>(<span class="params">base, args</span>) </span>&#123;</span><br><span class="line">  base = base || process.cwd();</span><br><span class="line">  args = args || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  EventEmitter.call(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.base_dir = base + sep;</span><br><span class="line">  <span class="keyword">this</span>.public_dir = pathFn.join(base, <span class="string">'public'</span>) + sep;</span><br><span class="line">  <span class="keyword">this</span>.source_dir = pathFn.join(base, <span class="string">'source'</span>) + sep;</span><br><span class="line">  <span class="keyword">this</span>.plugin_dir = pathFn.join(base, <span class="string">'node_modules'</span>) + sep;</span><br><span class="line">  <span class="keyword">this</span>.script_dir = pathFn.join(base, <span class="string">'scripts'</span>) + sep;</span><br><span class="line">  <span class="keyword">this</span>.scaffold_dir = pathFn.join(base, <span class="string">'scaffolds'</span>) + sep;</span><br><span class="line">  <span class="keyword">this</span>.theme_dir = pathFn.join(base, <span class="string">'themes'</span>, defaultConfig.theme) + sep;</span><br><span class="line">  <span class="keyword">this</span>.theme_script_dir = pathFn.join(<span class="keyword">this</span>.theme_dir, <span class="string">'scripts'</span>) + sep;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.env = &#123;</span><br><span class="line">    args: args,</span><br><span class="line">    debug: <span class="built_in">Boolean</span>(args.debug),</span><br><span class="line">    safe: <span class="built_in">Boolean</span>(args.safe),</span><br><span class="line">    silent: <span class="built_in">Boolean</span>(args.silent),</span><br><span class="line">    env: process.env.NODE_ENV || <span class="string">'development'</span>,</span><br><span class="line">    version: pkg.version,</span><br><span class="line">    init: <span class="literal">false</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.config_path = args.config ? pathFn.resolve(base, args.config)</span><br><span class="line">                                 : pathFn.join(base, <span class="string">'_config.yml'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.extend = &#123;</span><br><span class="line">    <span class="built_in">console</span>: <span class="keyword">new</span> extend.Console(),</span><br><span class="line">    deployer: <span class="keyword">new</span> extend.Deployer(),</span><br><span class="line">    filter: <span class="keyword">new</span> extend.Filter(),</span><br><span class="line">    generator: <span class="keyword">new</span> extend.Generator(),</span><br><span class="line">    helper: <span class="keyword">new</span> extend.Helper(),</span><br><span class="line">    migrator: <span class="keyword">new</span> extend.Migrator(),</span><br><span class="line">    processor: <span class="keyword">new</span> extend.Processor(),</span><br><span class="line">    renderer: <span class="keyword">new</span> extend.Renderer(),</span><br><span class="line">    tag: <span class="keyword">new</span> extend.Tag()</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.config = _.cloneDeep(defaultConfig);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.log = logger(<span class="keyword">this</span>.env);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.render = <span class="keyword">new</span> Render(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.route = <span class="keyword">new</span> Router();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.post = <span class="keyword">new</span> Post(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.scaffold = <span class="keyword">new</span> Scaffold(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._dbLoaded = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._isGenerating = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.database = <span class="keyword">new</span> Database(&#123;</span><br><span class="line">    version: dbVersion,</span><br><span class="line">    path: pathFn.join(base, <span class="string">'db.json'</span>)</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  registerModels(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.source = <span class="keyword">new</span> Source(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">this</span>.theme = <span class="keyword">new</span> Theme(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">this</span>.locals = <span class="keyword">new</span> Locals(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">this</span>._bindLocals();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Hexo</code> gets several directories such as <code>public_dir</code>, <code>source_dir</code>, etc. Then it defines the <code>this.extend</code> object, which contains <code>console</code>, <code>deployer</code>, etc. The format of each instance in the <code>this.extend</code> object is as follows:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Console</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</span><br><span class="line">  <span class="keyword">this</span>.alias = &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//-------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Deployer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//-------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Filter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//-------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Generator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.id = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//-------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Helper</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//-------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Migrator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//-------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Processor</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.store = [];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//-------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Renderer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</span><br><span class="line">  <span class="keyword">this</span>.storeSync = &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//-------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Tag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.env = <span class="keyword">new</span> nunjucks.Environment(<span class="literal">null</span>, &#123;</span><br><span class="line">    autoescape: <span class="literal">false</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//-------------------------</span></span><br></pre></td></tr></table></figure>
<p>All of them contain the same object <code>this.store</code>, which is used to map the name to the corresponding function. For example, <code>this.store</code> in <code>Console</code> is as follows:</p>
<p><img src="http://i.imgur.com/fB0X6I3.png" alt="this.store"></p>
<p>Each key in the object such as <code>clean</code>, <code>config</code> is of type string. What they are mapped to are functions that implement them.</p>
<p>Then it creates several instances, <code>logger</code>, <code>Render</code>, <code>Router</code>, <code>Post</code>, <code>Scaffold</code>, <code>database</code> etc. <code>logger</code> is used to log information on the console and the file, <code>Render</code> is used to render files(e.g. render markdownf files to html), <code>Router</code> is used to save all paths used in the site, <code>Post</code> is used to //TODO, <code>Scaffold</code> is used to //TODO, <code>database</code> is a <a href="https://github.com/tommy351/warehouse" target="_blank" rel="noopener">JSON-based database</a>.</p>
<p>It then registered following schemas using <code>registerModels(this)</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">exports.Asset = <span class="built_in">require</span>(<span class="string">'./asset'</span>);</span><br><span class="line">exports.Cache = <span class="built_in">require</span>(<span class="string">'./cache'</span>);</span><br><span class="line">exports.Category = <span class="built_in">require</span>(<span class="string">'./category'</span>);</span><br><span class="line">exports.Data = <span class="built_in">require</span>(<span class="string">'./data'</span>);</span><br><span class="line">exports.Page = <span class="built_in">require</span>(<span class="string">'./page'</span>);</span><br><span class="line">exports.Post = <span class="built_in">require</span>(<span class="string">'./post'</span>);</span><br><span class="line">exports.PostAsset = <span class="built_in">require</span>(<span class="string">'./post_asset'</span>);</span><br><span class="line">exports.PostCategory = <span class="built_in">require</span>(<span class="string">'./post_category'</span>);</span><br><span class="line">exports.PostTag = <span class="built_in">require</span>(<span class="string">'./post_tag'</span>);</span><br><span class="line">exports.Tag = <span class="built_in">require</span>(<span class="string">'./tag'</span>);</span><br></pre></td></tr></table></figure>
<p>Afterwards, two instances are initiated, <code>Source</code>, <code>Theme</code>,which represents <code>source</code> and <code>theme</code> folders respectively. They are both being processed by <code>Box</code>.</p>
<p>First, let’s look at <code>source</code>.js.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Box = <span class="built_in">require</span>(<span class="string">'../box'</span>);</span><br><span class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Source</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  Box.call(<span class="keyword">this</span>, ctx, ctx.source_dir);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.processors = ctx.extend.processor.list();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">util.inherits(Source, Box);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Source;</span><br></pre></td></tr></table></figure>
<p><code>ctx</code> refers to <code>Hexo</code>, <code>Source</code> function calls <code>Box</code> and gets the processor list, then it inherits <code>Box</code>. <code>Box</code> is used to read and render files in <code>source</code> or <code>theme</code> folder. To find out what’s going on, we need to look into the source code of <code>Box</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Box</span>(<span class="params">ctx, base, options</span>) </span>&#123;</span><br><span class="line">  EventEmitter.call(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.options = _.assign(&#123;</span><br><span class="line">    persistent: <span class="literal">true</span></span><br><span class="line">  &#125;, options);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if the last character of the working directory </span></span><br><span class="line">  <span class="comment">// is not /, add it to the end of base</span></span><br><span class="line">  <span class="keyword">if</span> (base.substring(base.length - <span class="number">1</span>) !== sep) &#123;</span><br><span class="line">    base += sep;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.context = ctx;</span><br><span class="line">  <span class="keyword">this</span>.base = base;</span><br><span class="line">  <span class="keyword">this</span>.processors = [];</span><br><span class="line">  <span class="keyword">this</span>._processingFiles = &#123;&#125;;</span><br><span class="line">  <span class="keyword">this</span>.watcher = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.Cache = ctx.model(<span class="string">'Cache'</span>);</span><br><span class="line">  <span class="keyword">this</span>.File = <span class="keyword">this</span>._createFileClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It sets several variables, then it gets the <code>Cache</code> model. The source code of <code>ctx.model</code> function is as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  Hexo.prototype.model = <span class="function"><span class="keyword">function</span>(<span class="params">name, schema</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.database.model(name, schema);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>If the model was created before, <code>this.database.model</code> will just return the model, or it will create the model with the specified <code>name</code> and <code>schema</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Database.prototype.model = <span class="function"><span class="keyword">function</span>(<span class="params">name, schema</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._models[name]) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._models[name];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> model = <span class="keyword">this</span>._models[name] = <span class="keyword">new</span> <span class="keyword">this</span>.Model(name, schema);</span><br><span class="line">  <span class="keyword">return</span> model;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Note that We have created the model in the <code>register_model</code> function, which is located in the <code>Hexo</code> function. When the code <code>new Hexo</code> is run, all the models are registered.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> models = <span class="built_in">require</span>(<span class="string">'../models'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> db = ctx.database;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> keys = <span class="built_in">Object</span>.keys(models);</span><br><span class="line">  <span class="keyword">var</span> key = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = keys.length; i &lt; len; i++) &#123;</span><br><span class="line">    key = keys[i];</span><br><span class="line">    db.model(key, models[key](ctx));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>The models created here were as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line">exports.Asset = <span class="built_in">require</span>(<span class="string">'./asset'</span>);</span><br><span class="line">exports.Cache = <span class="built_in">require</span>(<span class="string">'./cache'</span>);</span><br><span class="line">exports.Category = <span class="built_in">require</span>(<span class="string">'./category'</span>);</span><br><span class="line">exports.Data = <span class="built_in">require</span>(<span class="string">'./data'</span>);</span><br><span class="line">exports.Page = <span class="built_in">require</span>(<span class="string">'./page'</span>);</span><br><span class="line">exports.Post = <span class="built_in">require</span>(<span class="string">'./post'</span>);</span><br><span class="line">exports.PostAsset = <span class="built_in">require</span>(<span class="string">'./post_asset'</span>);</span><br><span class="line">exports.PostCategory = <span class="built_in">require</span>(<span class="string">'./post_category'</span>);</span><br><span class="line">exports.PostTag = <span class="built_in">require</span>(<span class="string">'./post_tag'</span>);</span><br><span class="line">exports.Tag = <span class="built_in">require</span>(<span class="string">'./tag'</span>);</span><br></pre></td></tr></table></figure>
<p>Which includes <code>cache</code>. So we can get the created <code>cache</code> model with <code>this.Cache = ctx.model(&#39;Cache&#39;);</code>. This model is used to cache generated posts and stuff, and store a hashed value for all of them. If the hash value is identical, hexo will not generate the post again, which reduces the generation time to a degree.</p>
<p>Now we only have a line left in the <code>box</code> function.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.File = <span class="keyword">this</span>._createFileClass();</span><br></pre></td></tr></table></figure>
<p><code>this.File</code> is used to read file contents and render it. The source code of <code>_createFileClass()</code> function is as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Box.prototype._createFileClass = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//ctx is Hexo</span></span><br><span class="line">  <span class="keyword">var</span> ctx = <span class="keyword">this</span>.context;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> _File = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    File.call(<span class="keyword">this</span>, data);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'util'</span>).inherits(_File, File);</span><br><span class="line"></span><br><span class="line">  _File.prototype.box = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  _File.prototype.render = <span class="function"><span class="keyword">function</span>(<span class="params">options, callback</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!callback &amp;&amp; <span class="keyword">typeof</span> options === <span class="string">'function'</span>) &#123;</span><br><span class="line">      callback = options;</span><br><span class="line">      options = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ctx.render.render(&#123;</span><br><span class="line">      path: <span class="keyword">this</span>.source</span><br><span class="line">    &#125;, options).asCallback(callback);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  _File.prototype.renderSync = <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ctx.render.renderSync(&#123;</span><br><span class="line">      path: <span class="keyword">this</span>.source</span><br><span class="line">    &#125;, options);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> _File;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>File.call(this, data)</code> sets <code>_File</code>‘s <code>source</code>, <code>path</code>, <code>params</code> and <code>type</code> as the same as ones in <code>data</code>. You can see it in the source of the <code>File</code> constructor.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">File</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.source = data.source;</span><br><span class="line">  <span class="keyword">this</span>.path = data.path;</span><br><span class="line">  <span class="keyword">this</span>.params = data.params;</span><br><span class="line">  <span class="keyword">this</span>.type = data.type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>_File</code> inherits <code>File</code> afterwards. Then it sets <code>render</code> and <code>renderSync</code> function of <code>_File</code> and returns it. As you can tell from their names, they are used to render files or strings, like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo.render.render(&#123;<span class="attr">text</span>: <span class="string">'example'</span>, <span class="attr">engine</span>: <span class="string">'swig'</span>&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo.render.render(&#123;<span class="attr">path</span>: <span class="string">'path/to/file.swig'</span>&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Render"><a href="#Render" class="headerlink" title="Render"></a>Render</h2><p>Let’s look into the <code>Render</code> object.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Render</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.context = ctx;</span><br><span class="line">  <span class="keyword">this</span>.renderer = ctx.extend.renderer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Still remember <code>renderer</code>? It’s used to store all the information about rendering.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Renderer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.store = &#123;&#125;;</span><br><span class="line">  <span class="keyword">this</span>.storeSync = &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The most important function in <code>render.js</code> is <code>Render.prototype.render</code>, the function is used to render text or files, the source code of it is as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Render.prototype.render = <span class="function"><span class="keyword">function</span>(<span class="params">data, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!callback &amp;&amp; <span class="keyword">typeof</span> options === <span class="string">'function'</span>) &#123;</span><br><span class="line">    callback = options;</span><br><span class="line">    options = &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> ctx = <span class="keyword">this</span>.context;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> ext = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!data) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'No input file or string!'</span>));</span><br><span class="line">    <span class="keyword">if</span> (data.text != <span class="literal">null</span>) <span class="keyword">return</span> resolve(data.text);</span><br><span class="line">    <span class="keyword">if</span> (!data.path) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'No input file or string!'</span>));</span><br><span class="line"></span><br><span class="line">    fs.readFile(data.path).then(resolve, reject);</span><br><span class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">    data.text = text;</span><br><span class="line">    ext = data.engine || getExtname(data.path);</span><br><span class="line">    <span class="keyword">if</span> (!ext || !self.isRenderable(ext)) <span class="keyword">return</span> text;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> renderer = self.getRenderer(ext);</span><br><span class="line">    <span class="keyword">return</span> renderer.call(ctx, data, options);</span><br><span class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    result = toString(result, data);</span><br><span class="line">    <span class="keyword">if</span> (data.onRenderEnd) &#123;</span><br><span class="line">      <span class="keyword">return</span> data.onRenderEnd(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> output = self.getOutput(ext) || ext;</span><br><span class="line">    <span class="keyword">return</span> ctx.execFilter(<span class="string">'after_render:'</span> + output, result, &#123;</span><br><span class="line">      context: ctx,</span><br><span class="line">      args: [data]</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;).asCallback(callback);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li><p>First, it checks if <code>data</code> exists or not, <code>data</code> contains text(<code>data.text</code>) or file(<code>data.path</code>) that is going to be rendered, it throws an error if it doesn’t exist.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!data) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'No input file or string!'</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>Then if <code>data.text</code> exists, it will try to render the text first.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (data.text != <span class="literal">null</span>) <span class="keyword">return</span> resolve(data.text);</span><br></pre></td></tr></table></figure>
</li>
<li><p>If <code>data.path</code> exists, it will try to analyze the file specified by <code>data.path</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!data.path) <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'No input file or string!'</span>));</span><br><span class="line">fs.readFile(data.path).then(resolve, reject);</span><br></pre></td></tr></table></figure>
</li>
<li><p>It tries to find out if the rendering engine exists in <code>renderer.store</code>, which maps the rendering engine’s name to the corresponding rendering function. If the engine exists, it will call the corresponding function to render it, return the original text if the engine doesn’t exist.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">data.text = text;</span><br><span class="line">ext = data.engine || getExtname(data.path);</span><br><span class="line"><span class="keyword">if</span> (!ext || !self.isRenderable(ext)) <span class="keyword">return</span> text;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get the function used to render</span></span><br><span class="line"><span class="keyword">var</span> renderer = self.getRenderer(ext);</span><br><span class="line"><span class="keyword">return</span> renderer.call(ctx, data, options);</span><br></pre></td></tr></table></figure>
<p><code>renderer</code> refers to the function that is used to render text or files. What <code>renderer.call()</code> returns is usually of JSON format. For example, if the file to be rendered is like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">archive_dir: archives</span><br><span class="line">author: John Doe</span><br></pre></td></tr></table></figure>
<p>The rendered result will be an object like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">archive_dir</span>: <span class="string">"archives"</span>, <span class="attr">author</span>: <span class="string">"John Doe"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>Some files are not rendered in this way, e.g. <code>md</code>. The rendering results of markdown files are of type string. <code>Hexo</code> creates a <code>toString</code> function to make the conversion happen.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = toString(result, data);</span><br></pre></td></tr></table></figure>
<p>The source code of <code>toString</code> function is as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toString</span>(<span class="params">result, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!options.hasOwnProperty(<span class="string">'toString'</span>) || <span class="keyword">typeof</span> result === <span class="string">'string'</span>) <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> options.toString === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> options.toString(result);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> result === <span class="string">'object'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(result);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.toString) &#123;</span><br><span class="line">    <span class="keyword">return</span> result.toString();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Because <code>md</code> files’s rendering results are of type string. so <code>toString</code> returns the original result directly in this case. Sometimes it needs to be further processed.</p>
<p>Afterwards, <code>onRenderEnd</code> is followed in order to modify some contents of <code>result</code> after rendering.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (data.onRenderEnd) &#123;</span><br><span class="line">  <span class="keyword">return</span> data.onRenderEnd(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then the result is transferred to the next <code>then</code> function, and the <code>after_render</code> filter is executed.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// output is the file's final type, e.g. html, css</span></span><br><span class="line">  <span class="comment">// the result of self.getOutput('md') would be 'html',</span></span><br><span class="line">  <span class="comment">// because the rendering result of a markdown file is of type html</span></span><br><span class="line">  <span class="keyword">var</span> output = self.getOutput(ext) || ext;</span><br><span class="line">  <span class="keyword">return</span> ctx.execFilter(<span class="string">'after_render:'</span> + output, result, &#123;</span><br><span class="line">    context: ctx,</span><br><span class="line">    args: [data]</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;).asCallback(callback);</span><br></pre></td></tr></table></figure>
<p>To make it even clearer about how to use <code>execFilter</code>, Here I give an example from the official Hexo website, the following code is used to uglify js files.</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> UglifyJS = <span class="built_in">require</span>(<span class="string">'uglify-js'</span>);</span><br><span class="line"></span><br><span class="line">hexo.extend.filter.register(<span class="string">'after_render:js'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">str, data</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result = UglifyJS.minify(str);</span><br><span class="line">  <span class="keyword">return</span> result.code;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>This is the source code of <code>register</code> function.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Filter.prototype.register = <span class="function"><span class="keyword">function</span>(<span class="params">type, fn, priority</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!priority) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> type === <span class="string">'function'</span>) &#123;</span><br><span class="line">      priority = fn;</span><br><span class="line">      fn = type;</span><br><span class="line">      type = <span class="string">'after_post_render'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'fn must be a function'</span>);</span><br><span class="line"></span><br><span class="line">  type = typeAlias[type] || type;</span><br><span class="line">  priority = priority == <span class="literal">null</span> ? <span class="number">10</span> : priority;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> store = <span class="keyword">this</span>.store[type] = <span class="keyword">this</span>.store[type] || [];</span><br><span class="line"></span><br><span class="line">  fn.priority = priority;</span><br><span class="line">  store.push(fn);</span><br><span class="line"></span><br><span class="line">  store.sort(<span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a.priority - b.priority;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>As you can see, it stores <code>type</code>(e.g. <code>after_post_render:js</code>) and the corresponding processing function in the <code>this.store</code> object. After the registration is over, <code>Filter.prototype.exec</code> executes the specified filter (<code>after_post_render:js</code> in this case).</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Filter.prototype.exec = <span class="function"><span class="keyword">function</span>(<span class="params">type, data, options</span>) </span>&#123;</span><br><span class="line">  options = options || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// filters are the functions that are registered before.</span></span><br><span class="line">  <span class="comment">// this.list(type) gets these functions from this.store</span></span><br><span class="line">  <span class="keyword">var</span> filters = <span class="keyword">this</span>.list(type);</span><br><span class="line">  <span class="keyword">var</span> ctx = options.context;</span><br><span class="line">  <span class="keyword">var</span> args = options.args || [];</span><br><span class="line"></span><br><span class="line">  args.unshift(data);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.each(filters, <span class="function"><span class="keyword">function</span>(<span class="params">filter</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.method(filter).apply(ctx, args).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">      <span class="comment">/* when the processing is over, the processing function returns</span></span><br><span class="line"><span class="comment">         the processed result, if the result equals null, it will return</span></span><br><span class="line"><span class="comment">         the original one without processed by the filter(data), if the</span></span><br><span class="line"><span class="comment">         result is not null, it will return the result processed by the</span></span><br><span class="line"><span class="comment">         filter */</span></span><br><span class="line">      args[<span class="number">0</span>] = result == <span class="literal">null</span> ? data : result;</span><br><span class="line">      <span class="keyword">return</span> args[<span class="number">0</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> args[<span class="number">0</span>];</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>OK, this part is over, let’s look into the <code>theme/index.js</code> file next.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pathFn = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"><span class="keyword">var</span> Box = <span class="built_in">require</span>(<span class="string">'../box'</span>);</span><br><span class="line"><span class="keyword">var</span> View = <span class="built_in">require</span>(<span class="string">'./view'</span>);</span><br><span class="line"><span class="keyword">var</span> I18n = <span class="built_in">require</span>(<span class="string">'hexo-i18n'</span>);</span><br><span class="line"><span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Theme</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  Box.call(<span class="keyword">this</span>, ctx, ctx.theme_dir);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.config = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.views = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.processors = [</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'./processors/config'</span>),</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'./processors/i18n'</span>),</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'./processors/source'</span>),</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'./processors/view'</span>)</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> languages = ctx.config.language;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(languages)) &#123;</span><br><span class="line">    languages = [languages];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  languages.push(<span class="string">'default'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.i18n = <span class="keyword">new</span> I18n(&#123;</span><br><span class="line">    languages: _(languages).compact().uniq().value()</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> _View = <span class="keyword">this</span>.View = <span class="function"><span class="keyword">function</span>(<span class="params">path, data</span>) </span>&#123;</span><br><span class="line">    View.call(<span class="keyword">this</span>, path, data);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  util.inherits(_View, View);</span><br><span class="line"></span><br><span class="line">  _View.prototype._theme = <span class="keyword">this</span>;</span><br><span class="line">  _View.prototype._render = ctx.render;</span><br><span class="line">  _View.prototype._helper = ctx.extend.helper;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">util.inherits(Theme, Box);</span><br></pre></td></tr></table></figure>
<p>The function <code>Theme</code> also calls <code>Box()</code>, then it adds several processors and sets languages and views.</p>
<p>Then it bind locals.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">  Hexo.prototype._bindLocals = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> db = <span class="keyword">this</span>.database;</span><br><span class="line">  <span class="keyword">var</span> locals = <span class="keyword">this</span>.locals;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  locals.set(<span class="string">'posts'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> query = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!self.config.future) &#123;</span><br><span class="line">      query.date = &#123;<span class="attr">$lte</span>: <span class="built_in">Date</span>.now()&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!self._showDrafts()) &#123;</span><br><span class="line">      query.published = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> db.model(<span class="string">'Post'</span>).find(query);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  locals.set(<span class="string">'pages'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> query = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!self.config.future) &#123;</span><br><span class="line">      query.date = &#123;<span class="attr">$lte</span>: <span class="built_in">Date</span>.now()&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> db.model(<span class="string">'Page'</span>).find(query);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  locals.set(<span class="string">'categories'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> db.model(<span class="string">'Category'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  locals.set(<span class="string">'tags'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> db.model(<span class="string">'Tag'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  locals.set(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    db.model(<span class="string">'Data'</span>).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">      obj[data._id] = data.data;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="4">
<li><p>After loading module is over, it calls <code>console</code> to execute the provided command</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> loadModule(path, args).catch(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    log.error(<span class="string">'Local hexo not found in %s'</span>, chalk.magenta(tildify(path)));</span><br><span class="line">    log.error(<span class="string">'Try running: \'npm install hexo --save\''</span>);</span><br><span class="line">    process.exit(<span class="number">2</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">mod</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (mod) hexo = mod;</span><br><span class="line">  log = hexo.log;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'./console'</span>)(hexo);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> hexo.init();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>  Let’s look through the source code of <code>./console</code>.</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> <span class="built_in">console</span> = ctx.extend.console;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.register(<span class="string">'help'</span>, <span class="string">'Get help on a command.'</span>, &#123;</span><br><span class="line">  &#125;, <span class="built_in">require</span>(<span class="string">'./help'</span>));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.register(<span class="string">'init'</span>, <span class="string">'Create a new Hexo folder.'</span>, &#123;</span><br><span class="line">  desc: <span class="string">'Create a new Hexo folder at the specified path or the current directory.'</span>,</span><br><span class="line">  usage: <span class="string">'[destination]'</span>,</span><br><span class="line">  <span class="built_in">arguments</span>: [</span><br><span class="line">    &#123;<span class="attr">name</span>: <span class="string">'destination'</span>, <span class="attr">desc</span>: <span class="string">'Folder path. Initialize in current folder if not specified'</span>&#125;</span><br><span class="line">  ],</span><br><span class="line">  options: [</span><br><span class="line">    &#123;<span class="attr">name</span>: <span class="string">'--no-clone'</span>, <span class="attr">desc</span>: <span class="string">'Copy files instead of cloning from GitHub'</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">name</span>: <span class="string">'--no-install'</span>, <span class="attr">desc</span>: <span class="string">'Skip npm install'</span>&#125;</span><br><span class="line">  ]</span><br><span class="line">  &#125;, <span class="built_in">require</span>(<span class="string">'./init'</span>));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.register(<span class="string">'version'</span>, <span class="string">'Display version information.'</span>, &#123;</span><br><span class="line">  &#125;, <span class="built_in">require</span>(<span class="string">'./version'</span>));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>  It registers several commands using <code>console.register</code>, let’s look through its source code.</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Console.prototype.register = <span class="function"><span class="keyword">function</span>(<span class="params">name, desc, options, fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!name) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'name is required'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!fn) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) &#123;</span><br><span class="line">        fn = options;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> desc === <span class="string">'object'</span>) &#123; <span class="comment">// name, options, fn</span></span><br><span class="line">          options = desc;</span><br><span class="line">          desc = <span class="string">''</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// name, desc, fn</span></span><br><span class="line">          options = &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'fn must be a function'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// name, fn</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> desc === <span class="string">'function'</span>) &#123;</span><br><span class="line">        fn = desc;</span><br><span class="line">        options = &#123;&#125;;</span><br><span class="line">        desc = <span class="string">''</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'fn must be a function'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fn.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    fn = <span class="built_in">Promise</span>.promisify(fn);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    fn = <span class="built_in">Promise</span>.method(fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> c = <span class="keyword">this</span>.store[name.toLowerCase()] = fn;</span><br><span class="line">  c.options = options;</span><br><span class="line">  c.desc = desc;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.alias = abbrev(<span class="built_in">Object</span>.keys(<span class="keyword">this</span>.store));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

        </div>
        <footer class="article-footer">
            



    <a data-url="https://searene.github.io/2016/07/17/Hexo-Source-Code-Demystified/" data-id="ckyvq12v90012inyhtbo7lfvg" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>

                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>follow:</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/searene" target="_blank">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="stack-overflow" href="https://stackoverflow.com/users/1031769/searene?tab=profile" target="_blank">
                        <i class="icon fa fa-stack-overflow"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="http://feeds.feedburner.com/Searene" target="_blank">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2016/09/30/Calculate-1-lambda-n-n/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">newer</strong>
        <p class="article-nav-title">
        
            Calculate $$\lim\limits_{n\to\infty}(1-\frac{\lambda_n}n)^n$$
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2016/07/04/The-fee-paid-to-freelancer-is-not-refundable/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">older</strong>
        <p class="article-nav-title">The fee paid to freelancer is not refundable</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap">
        <h3 class="widget-title">recents</h3>
        <div class="widget">
            <ul id="recent-post" class>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2022/01/26/一篇新的博客/" class="thumbnail">
    
    
        <span style="background-image:url(/images/writing.png)" alt="一篇新的博客" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Journal/">Journal</a></p>
                            <p class="item-title"><a href="/2022/01/26/一篇新的博客/" class="title">一篇新的博客</a></p>
                            <p class="item-date"><time datetime="2022-01-26T15:27:55.000Z" itemprop="datePublished">2022-01-26</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/07/10/Nothing-makes-sense/" class="thumbnail">
    
    
        <span style="background-image:url(/images/WhenLifeSeemsMeaningless.jpg)" alt="Nothing makes sense" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Journal/">Journal</a></p>
                            <p class="item-title"><a href="/2020/07/10/Nothing-makes-sense/" class="title">Nothing makes sense</a></p>
                            <p class="item-date"><time datetime="2020-07-10T14:52:12.000Z" itemprop="datePublished">2020-07-10</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/06/26/I-had-a-dream-last-night/" class="thumbnail">
    
    
        <span style="background-image:url(/images/swim.jpg)" alt="I had a dream last night" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Life/">Life</a></p>
                            <p class="item-title"><a href="/2020/06/26/I-had-a-dream-last-night/" class="title">I had a dream last night</a></p>
                            <p class="item-date"><time datetime="2020-06-26T08:07:39.000Z" itemprop="datePublished">2020-06-26</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2019/09/10/I-need-to-stop-making-my-life-worse/" class="thumbnail">
    
    
        <span style="background-image:url(/images/thewaronfeelings.jpg)" alt="I need to stop making my life worse" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Journal/">Journal</a></p>
                            <p class="item-title"><a href="/2019/09/10/I-need-to-stop-making-my-life-worse/" class="title">I need to stop making my life worse</a></p>
                            <p class="item-date"><time datetime="2019-09-10T13:43:49.000Z" itemprop="datePublished">2019-09-10</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2019/06/14/Finished-Home-Deus-a-brief-history-of-tomorrow/" class="thumbnail">
    
    
        <span style="background-image:url(/images/homo_deus.jpg)" alt="Finished Home Deus, a brief history of tomorrow" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Journal/">Journal</a></p>
                            <p class="item-title"><a href="/2019/06/14/Finished-Home-Deus-a-brief-history-of-tomorrow/" class="title">Finished Home Deus, a brief history of tomorrow</a></p>
                            <p class="item-date"><time datetime="2019-06-14T12:55:50.000Z" itemprop="datePublished">2019-06-14</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Coding/">Coding</a><span class="category-list-count">49</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Journal/">Journal</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Journey/">Journey</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Life/">Life</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Math/">Math</a><span class="category-list-count">5</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">14</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Big-Data/">Big Data</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-Scala/">Java, Scala</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/">Kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Neural-Network/">Neural Network</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scala/">Scala</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/">algorithm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/anki/">anki</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/archlinux/">archlinux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/book/">book</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chrome/">chrome</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/composition/">composition</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/">django</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dnsmasq/">dnsmasq</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/encoding/">encoding</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fcitx/">fcitx</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/firefox/">firefox</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hadoop/">hadoop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hueman/">hueman</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/i3/">i3</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/">jvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/">kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/">leetcode</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/">life</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/limit/">limit</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/machine-learning/">machine learning</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/math/">math</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mathjax/">mathjax</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/multi-thread-java-scala/">multi-thread, java, scala</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysqldb/">mysqldb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">network</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network-manager/">network-manager</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/poisson/">poisson</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/probability/">probability</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/proof/">proof</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pycharm/">pycharm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/set-thoery/">set-thoery</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sublime/">sublime</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/">ubuntu</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtualbox/">virtualbox</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/win7/">win7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zsh/">zsh</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/Big-Data/" style="font-size: 10px;">Big Data</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Java-Scala/" style="font-size: 10px;">Java, Scala</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/Neural-Network/" style="font-size: 10px;">Neural Network</a> <a href="/tags/Scala/" style="font-size: 12px;">Scala</a> <a href="/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/tags/anki/" style="font-size: 16px;">anki</a> <a href="/tags/archlinux/" style="font-size: 10px;">archlinux</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/chrome/" style="font-size: 10px;">chrome</a> <a href="/tags/composition/" style="font-size: 10px;">composition</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/dnsmasq/" style="font-size: 10px;">dnsmasq</a> <a href="/tags/encoding/" style="font-size: 10px;">encoding</a> <a href="/tags/fcitx/" style="font-size: 12px;">fcitx</a> <a href="/tags/firefox/" style="font-size: 10px;">firefox</a> <a href="/tags/git/" style="font-size: 12px;">git</a> <a href="/tags/hadoop/" style="font-size: 10px;">hadoop</a> <a href="/tags/hexo/" style="font-size: 14px;">hexo</a> <a href="/tags/hueman/" style="font-size: 10px;">hueman</a> <a href="/tags/i3/" style="font-size: 10px;">i3</a> <a href="/tags/java/" style="font-size: 16px;">java</a> <a href="/tags/javascript/" style="font-size: 14px;">javascript</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/kafka/" style="font-size: 10px;">kafka</a> <a href="/tags/leetcode/" style="font-size: 10px;">leetcode</a> <a href="/tags/life/" style="font-size: 10px;">life</a> <a href="/tags/limit/" style="font-size: 12px;">limit</a> <a href="/tags/linux/" style="font-size: 20px;">linux</a> <a href="/tags/machine-learning/" style="font-size: 10px;">machine learning</a> <a href="/tags/math/" style="font-size: 14px;">math</a> <a href="/tags/mathjax/" style="font-size: 10px;">mathjax</a> <a href="/tags/multi-thread-java-scala/" style="font-size: 10px;">multi-thread, java, scala</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/mysqldb/" style="font-size: 10px;">mysqldb</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/network-manager/" style="font-size: 10px;">network-manager</a> <a href="/tags/poisson/" style="font-size: 10px;">poisson</a> <a href="/tags/probability/" style="font-size: 10px;">probability</a> <a href="/tags/proof/" style="font-size: 10px;">proof</a> <a href="/tags/pycharm/" style="font-size: 10px;">pycharm</a> <a href="/tags/python/" style="font-size: 18px;">python</a> <a href="/tags/set-thoery/" style="font-size: 10px;">set-thoery</a> <a href="/tags/shell/" style="font-size: 12px;">shell</a> <a href="/tags/sublime/" style="font-size: 10px;">sublime</a> <a href="/tags/ubuntu/" style="font-size: 14px;">ubuntu</a> <a href="/tags/vim/" style="font-size: 14px;">vim</a> <a href="/tags/virtualbox/" style="font-size: 10px;">virtualbox</a> <a href="/tags/win7/" style="font-size: 10px;">win7</a> <a href="/tags/zsh/" style="font-size: 10px;">zsh</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2022 Searene</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'searene';
    
    
    var disqus_url = 'https://searene.github.io/2016/07/17/Hexo-Source-Code-Demystified/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>



    
        <script src="/vendor/fancybox/jquery.fancybox.pack.js"></script>
    

    
        <script src="/vendor/scrollLoading/jquery.scrollLoading.js"></script>
        <script src="/vendor/scrollLoading/main.js"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js"></script>


        <!-- mathjax config similar to math.stackexchange -->

<script type="text/javascript">
$(document).ready(function(){
  $("code").map(function(){
    match = /^\$(.*)\$$/.exec($(this).html());
    if (match){
      //$(this).after("<span class=mathjax_inline>" + match + "</span>");
      //$(this).hide();
      $(this).replaceWith("<span class=hpl_mathjax_inline>" + $(this).html() + "</span>");
      MathJax.Hub.Queue(["Typeset",MathJax.Hub,$(this).get(0)]);
    }
  });
});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

    </div>
</body>
</html>
